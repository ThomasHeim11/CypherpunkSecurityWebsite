name: 🚀 Continuous Integration

on:
  push:
    branches: [main, develop, feature/*, hotfix/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ===========================
  # BASIC VALIDATION
  # ===========================
  basic-checks:
    name: 🔍 Basic Checks
    runs-on: ubuntu-latest
    steps:
      - name: 🛒 Checkout Repository
        uses: actions/checkout@v4

      - name: ✅ Status Report
        run: |
          echo "## 🔍 Basic Checks" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Basic checks completed successfully"

  # ===========================
  # INSTALL AND TEST
  # ===========================
  test:
    name: 🧪 Test Suite
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: 🛒 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📥 Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: 🔍 Lint Check
        run: npm run lint

      - name: 🔍 Type Check
        run: npm run type-check

      - name: 🧪 Run Tests
        run: npm run test:ci

      - name: 📊 Test Summary
        run: |
          echo "## 🧪 Test Results" >> $GITHUB_STEP_SUMMARY
          echo "✅ All tests passed successfully" >> $GITHUB_STEP_SUMMARY

  # ===========================
  # BUILD VALIDATION
  # ===========================
  build:
    name: 🏗️ Build
    runs-on: ubuntu-latest
    needs: [basic-checks, test]
    steps:
      - name: 🛒 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📥 Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: 🏗️ Build Application
        run: npm run build

      - name: 📊 Build Summary
        run: |
          echo "## 🏗️ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY

  # ===========================
  # FINAL STATUS
  # ===========================
  status:
    name: ✅ Final Status
    runs-on: ubuntu-latest
    needs: [basic-checks, test, build]
    if: always()
    steps:
      - name: 📊 Overall Status
        run: |
          echo "## 🎯 Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Basic Checks**: ${{ needs.basic-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.basic-checks.result }}" == "success" && 
                "${{ needs.test.result }}" == "success" && 
                "${{ needs.build.result }}" == "success" ]]; then
            echo "✅ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "❌ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
